# –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä –∏ —Ñ–ª–∞–≥–∏
CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -pthread
INCLUDES = -I./common -I/usr/local/include -I/usr/include
LIBS = -lzmq -pthread

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
SERVER_DIR = server
CLIENT_DIR = client
COMMON_DIR = common

# –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
SERVER_SRC = $(SERVER_DIR)/main.cpp
CLIENT_SRC = $(CLIENT_DIR)/main.cpp

# –ó–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–µ —Ñ–∞–π–ª—ã
COMMON_HEADERS = $(COMMON_DIR)/Student.h \
                 $(COMMON_DIR)/Validator.h \
                 $(COMMON_DIR)/Serializer.h

SERVER_HEADERS = $(SERVER_DIR)/FileParser.h \
                 $(SERVER_DIR)/StudentMerger.h \
                 $(SERVER_DIR)/ZmqSyncedPublisher.h \
                 $(COMMON_HEADERS)

CLIENT_HEADERS = $(CLIENT_DIR)/ZmqSyncedSubscriber.h \
                 $(CLIENT_DIR)/StudentSorter.h \
                 $(COMMON_HEADERS)

# –¶–µ–ª–µ–≤—ã–µ —Ñ–∞–π–ª—ã
SERVER_TARGET = server_app
CLIENT_TARGET = client_app

all: $(SERVER_TARGET) $(CLIENT_TARGET)
	@echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
	@echo "   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'make run-server' –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"
	@echo "   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'make run-client' –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞"

# –°–±–æ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
$(SERVER_TARGET): $(SERVER_SRC) $(SERVER_HEADERS)
	@echo "üî® –ö–æ–º–ø–∏–ª—è—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -I$(SERVER_DIR) $(SERVER_SRC) -o $(SERVER_TARGET) $(LIBS)
	@echo "‚úÖ –°–µ—Ä–≤–µ—Ä —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω: $(SERVER_TARGET)"

# –°–±–æ—Ä–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞
$(CLIENT_TARGET): $(CLIENT_SRC) $(CLIENT_HEADERS)
	@echo "üî® –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -I$(CLIENT_DIR) $(CLIENT_SRC) -o $(CLIENT_TARGET) $(LIBS)
	@echo "‚úÖ –ö–ª–∏–µ–Ω—Ç —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω: $(CLIENT_TARGET)"

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
run-server: $(SERVER_TARGET)
	@echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞..."
	./$(SERVER_TARGET)

# –ó–∞–ø—É—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞
run-client: $(CLIENT_TARGET)
	@echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞..."
	./$(CLIENT_TARGET)

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
test-files:
	@echo "üìù –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤..."
	@echo "1 Ivan Ivanovich Ivanov 01.01.1988" > student_file_1.txt
	@echo "2 Petr Petrovich Petrov 04.07.1988" >> student_file_1.txt
	@echo "3 Denis Denisovich Denisov 43.01.1988" >> student_file_1.txt
	@echo "4 Vladimir Vladimirovich Jukov 04.5.1987" >> student_file_1.txt
	@echo "5 Vladimir Vladimirovich Kochkin 11.10.1989" >> student_file_1.txt
	@echo "" >> student_file_1.txt
	@echo "34 Ivan Ivanovich Ivanov 01.01.1988" > student_file_2.txt
	@echo "54 Petr Petrovich Kazakov 05.07.1986" >> student_file_2.txt
	@echo "23 Denis Denisovich Denisov 04.03.1988" >> student_file_2.txt
	@echo "12 Vladimir Vladimirovich Jukov 04.5.1987" >> student_file_2.txt
	@echo "43 Vladimir Vladimirovich Kochkin 11.11.1989" >> student_file_2.txt
	@echo "" >> student_file_2.txt
	@echo "‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
check-deps:
	@echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
	@which $(CXX) > /dev/null || (echo "‚ùå $(CXX) –Ω–µ –Ω–∞–π–¥–µ–Ω" && exit 1)
	@echo "‚úÖ –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä $(CXX) –Ω–∞–π–¥–µ–Ω"
	@pkg-config --exists libzmq || (echo "‚ùå libzmq –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: sudo apt-get install libzmq3-dev" && exit 1)
	@echo "‚úÖ ZeroMQ –Ω–∞–π–¥–µ–Ω"
	@echo "‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# –û—á–∏—Å—Ç–∫–∞
clean:
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞..."
	rm -f $(SERVER_TARGET) $(CLIENT_TARGET)
	rm -f *.o
	@echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–≤–∫–ª—é—á–∞—è —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã)
distclean: clean
	rm -f student_file_1.txt student_file_2.txt
	@echo "‚úÖ –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
